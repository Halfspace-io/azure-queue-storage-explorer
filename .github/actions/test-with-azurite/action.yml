name: 'Test with Azurite'
description: 'Run tests with and without Azurite running'
inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  pnpm-version:
    description: 'pnpm version to use'
    required: false
    default: 'latest'
  azurite-version:
    description: 'Azurite version to use'
    required: false
    default: 'latest'

runs:
  using: 'composite'
  steps:
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ inputs.pnpm-version }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'pnpm'
        
    - name: Install dependencies
      shell: bash
      run: pnpm install
      
    - name: Compile TypeScript
      shell: bash
      run: pnpm run compile
      
    - name: Setup virtual display for VS Code tests
      shell: bash
      run: |
        echo "ðŸ–¥ï¸ Setting up virtual display for headless testing..."
        sudo apt-get update
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        export ELECTRON_DISABLE_SANDBOX=1
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        echo $! > /tmp/xvfb.pid
        sleep 3
        echo "âœ… Virtual display ready"
        
    - name: Run tests without Azurite
      shell: bash
      run: |
        echo "ðŸ§ª Running tests without Azurite..."
        export DISPLAY=:99
        export ELECTRON_DISABLE_SANDBOX=1
        pnpm test
        echo "âœ… Tests without Azurite completed successfully"
        
    - name: Install Azurite
      shell: bash
      run: |
        echo "ðŸ“¦ Installing Azurite..."
        pnpm add -g azurite@${{ inputs.azurite-version }}
        
    - name: Start Azurite
      shell: bash
      run: |
        echo "ðŸš€ Starting Azurite..."
        
        # Create directory for Azurite data
        mkdir -p /tmp/azurite
        
        # Start Azurite in background
        azurite --silent --location /tmp/azurite --debug /tmp/azurite/debug.log --loose &
        echo $! > /tmp/azurite.pid
        
        # Wait for Azurite to start
        echo "â³ Waiting for Azurite to start..."
        for i in {1..30}; do
          if curl -s -f http://127.0.0.1:10001/devstoreaccount1 > /dev/null 2>&1; then
            echo "âœ… Azurite is running!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        # Verify Azurite is running
        if ! curl -s -f http://127.0.0.1:10001/devstoreaccount1 > /dev/null 2>&1; then
          echo "âŒ Azurite failed to start"
          echo "Debug log:"
          cat /tmp/azurite/debug.log 2>/dev/null || echo "No debug log available"
          exit 1
        fi
        
        # Additional verification
        echo "ðŸ” Verifying Azurite endpoints..."
        curl -s http://127.0.0.1:10001/devstoreaccount1 || echo "Queue service check failed"
        curl -s http://127.0.0.1:10000/devstoreaccount1 || echo "Blob service check failed"
        curl -s http://127.0.0.1:10002/devstoreaccount1 || echo "Table service check failed"
        
    - name: Run tests with Azurite
      shell: bash
      run: |
        echo "ðŸ§ª Running tests with Azurite..."
        export DISPLAY=:99
        export ELECTRON_DISABLE_SANDBOX=1
        pnpm test
        echo "âœ… Tests with Azurite completed successfully"
        
    - name: Stop Azurite and cleanup
      if: always()
      shell: bash
      run: |
        echo "ðŸ›‘ Stopping Azurite..."
        if [ -f /tmp/azurite.pid ]; then
          kill $(cat /tmp/azurite.pid) 2>/dev/null || true
          rm -f /tmp/azurite.pid
        fi
        echo "âœ… Azurite stopped"
        
        echo "ðŸ›‘ Stopping virtual display..."
        if [ -f /tmp/xvfb.pid ]; then
          kill $(cat /tmp/xvfb.pid) 2>/dev/null || true
          rm -f /tmp/xvfb.pid
        fi
        echo "âœ… Virtual display stopped"
